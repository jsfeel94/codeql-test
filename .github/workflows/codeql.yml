name: "CodeQL Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    # The branches below must be a subset of the branches above
    branches: [ "main", "develop" ]
  schedule:
    - cron: '0 2 * * 1'  # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 2ì‹œì— ì‹¤í–‰

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    permissions:
      # CodeQLì´ í•„ìš”í•œ ê¶Œí•œ
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        # CodeQLì´ ì§€ì›í•˜ëŠ” ì–¸ì–´ ëª©ë¡
        language: [ 'java' ]
        # ë‹¤ë¥¸ ì–¸ì–´ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
        # language: [ 'java', 'javascript', 'python', 'cpp' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        # CodeQL ì¿¼ë¦¬ ì„¤ì • ì˜µì…˜ë“¤:
        # queries: security-and-quality  # ê¸°ë³¸: ë³´ì•ˆ + í’ˆì§ˆ ì¿¼ë¦¬
        # queries: security-extended     # í™•ì¥: ë” ë§ì€ ë³´ì•ˆ ì¿¼ë¦¬ (ê°€ì–‘ì„± ê°€ëŠ¥)
        # queries: default               # ê¸°ë³¸: ì •í™•ë„ ë†’ì€ ì¿¼ë¦¬ë§Œ
        # queries: security              # ë³´ì•ˆ: ë³´ì•ˆ ê´€ë ¨ ì¿¼ë¦¬ë§Œ
        # queries: quality               # í’ˆì§ˆ: ì½”ë“œ í’ˆì§ˆ ì¿¼ë¦¬ë§Œ
        queries: security-and-quality
        
        # ì‚¬ìš©ì ì •ì˜ ì¿¼ë¦¬ ì„¤ì • ì˜ˆì‹œ:
        # queries: |
        #   - name: security-and-quality
        #   - uses: security-extended
        #   - name: custom-queries
        #     uses: ./.github/codeql-queries

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build with Maven
      run: |
        mvn clean compile -DskipTests

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"

  # ì¶”ê°€ì ì¸ ë³´ì•ˆ ìŠ¤ìº” ì‘ì—…
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: analyze
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v3
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Run SpotBugs Security Analysis
      run: |
        mvn spotbugs:check -Dspotbugs.failOnError=false
      continue-on-error: true

    - name: Run OWASP Dependency Check
      run: |
        mvn org.owasp:dependency-check-maven:check -DfailOnError=false
      continue-on-error: true

    - name: Comment PR with Security Results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // CodeQL ê²°ê³¼ ìš”ì•½
          const codeqlSummary = `
          ## ğŸ” CodeQL Security Analysis Results
          
          CodeQL ë¶„ì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ê²°ê³¼ëŠ” Security íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          
          ### ë¶„ì„ëœ ì–¸ì–´
          - Java
          
          ### ì£¼ìš” ë³´ì•ˆ ì·¨ì•½ì  ìœ í˜•
          - SQL Injection
          - Command Injection  
          - Path Traversal
          - XSS (Cross-Site Scripting)
          - Weak Cryptography
          - Hardcoded Secrets
          - Unsafe Deserialization
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: codeqlSummary
          });
